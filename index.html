<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=1">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Add Select2 CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  <!-- Add jQuery (Select2 depends on jQuery) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Add Select2 JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

  <style>
    /* Your existing CSS styles */
    /* ... (omitted for brevity) ... */
  </style>
</head>

<body>
  <!-- Your existing HTML content -->
  <!-- ... (omitted for brevity) ... -->

  <script>
    /*******************************************************
     * FORM DATA
     *******************************************************/
    const formData = {
      age: "",
      gender: "",
      city: "",
      buyingThisYear: "",
      owner: "",
      budget: "",
      car: "",
      fuel: "",
      selectedFeatures: [],
      pairwiseAnswers: [],
    };

    /*******************************************************
     * PAGE NAVIGATION
     *******************************************************/
    function showPage(pageId) {
      document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
      document.getElementById(pageId).classList.add("active");
    }

    // PAGE 1 => 2
    function nextFromAge() {
      const ageRadio = document.querySelector('input[name="age"]:checked');
      if (!ageRadio) {
        alert("Please select your age range.");
        return;
      }
      formData.age = ageRadio.value;
      showPage("page2");
    }

    // PAGE 2 => 3
    function nextFromGender() {
      const genderRadio = document.querySelector('input[name="gender"]:checked');
      if (!genderRadio) {
        alert("Please select your gender.");
        return;
      }
      formData.gender = genderRadio.value;
      showPage("page3");
    }

    // PAGE 3 => 4
    function nextFromCity() {
      const cityDropdown = document.getElementById("citySelect");
      const selectedCity = cityDropdown.value.trim();

      if (!selectedCity) {
        alert("Please select your city.");
        return;
      }
      // Validate that the selected city is in the dropdown
      const validCities = Array.from(cityDropdown.options).map(opt => opt.value);
      if (!validCities.includes(selectedCity)) {
        alert("Please select a valid city from the list.");
        cityDropdown.value = "";
        cityDropdown.focus();
        return;
      }

      formData.city = selectedCity;
      showPage("page4");
    }

    // PAGE 4 => Next or Thank You
    function checkBuyingThisYear() {
      const buyingRadio = document.querySelector('input[name="buyingThisYear"]:checked');
      if (!buyingRadio) {
        alert("Please select Yes or No.");
        return;
      }
      formData.buyingThisYear = buyingRadio.value;

      if (buyingRadio.value === "Yes") {
        showPage("page5"); // Ownership
      } else {
        // Show Thank You page & end
        showPage("pageThankYou");
      }
    }

    // PAGE 5 => 6
    function nextFromOwner() {
      const ownerRadio = document.querySelector('input[name="owner"]:checked');
      if (!ownerRadio) {
        alert("Please select car ownership (Yes or No).");
        return;
      }
      formData.owner = ownerRadio.value;
      showPage("page6");
    }

    // PAGE 6 => 7
    function nextFromBudget() {
      const budgetRadio = document.querySelector('input[name="budget"]:checked');
      if (!budgetRadio) {
        alert("Please select your budget range.");
        return;
      }
      formData.budget = budgetRadio.value;
      showPage("page7");
    }

    // PAGE 7 => 8
    function nextFromCar() {
      const carDropdown = document.getElementById("carSelect");
      const selectedCar = carDropdown.value.trim();

      if (!selectedCar) {
        alert("Please select a valid car.");
        return;
      }
      const validCars = Array.from(carDropdown.options).map(opt => opt.value);
      if (!validCars.includes(selectedCar)) {
        alert("Please select a valid car from the list.");
        carDropdown.value = "";
        carDropdown.focus();
        return;
      }

      formData.car = selectedCar;
      showPage("page8");
    }

    // PAGE 8 => 9
    function goToFeatures() {
      const fuelRadio = document.querySelector('input[name="fuel"]:checked');
      if (!fuelRadio) {
        alert("Please select your preferred fuel type.");
        return;
      }
      formData.fuel = fuelRadio.value;
      showPage("page9");
    }

    /*******************************************************
     * FEATURES (PAGE 9)
     *******************************************************/
    let selectedCount = 0;
    const maxCheckboxes = 5;
    let selectedOptions = [];

    // Your existing checkboxOptions array
    // ... (omitted for brevity) ...

    // Shuffle them up randomly
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    shuffle(checkboxOptions);

    // Split into two columns
    const block1 = checkboxOptions.slice(0, 15);
    const block2 = checkboxOptions.slice(15);

    // Render features into 2 blocks
    const block1Container = document.getElementById("checkboxesBlock1");
    const block2Container = document.getElementById("checkboxesBlock2");

    block1.forEach((feature, index) => {
      const label = document.createElement("label");
      label.className = "option-label";
      label.innerHTML = `
        <input
          class="option-label-checkbox"
          type="checkbox"
          name="option"
          onclick="updateCheckboxCount(this)"
        />
        <span class="option-label-number">${index + 1}. </span>
        <span class="option-label-text">${feature}</span>
      `;
      block1Container.appendChild(label);
    });

    block2.forEach((feature, index) => {
      const label = document.createElement("label");
      label.className = "option-label";
      label.innerHTML = `
        <input
          class="option-label-checkbox"
          type="checkbox"
          name="option"
          onclick="updateCheckboxCount(this)"
        />
        <span class="option-label-number">${index + 16}. </span>
        <span class="option-label-text">${feature}</span>
      `;
      block2Container.appendChild(label);
    });

    function updateCheckboxCount(checkbox) {
      if (checkbox.checked) {
        selectedCount++;
        if (selectedCount > maxCheckboxes) {
          checkbox.checked = false;
          selectedCount--;
          alert(`You can only select up to ${maxCheckboxes} features.`);
          return;
        }
      } else {
        selectedCount--;
      }
      document.getElementById("countText").textContent =
        `You have selected ${selectedCount} out of ${maxCheckboxes}. Please select exactly ${maxCheckboxes}.`;

      if (selectedCount >= maxCheckboxes) {
        disableRemainingCheckboxes();
      } else {
        enableAllCheckboxes();
      }
    }

    function disableRemainingCheckboxes() {
      document.querySelectorAll('input[name="option"]').forEach(cb => {
        if (!cb.checked) cb.disabled = true;
      });
    }

    function enableAllCheckboxes() {
      document.querySelectorAll('input[name="option"]').forEach(cb => {
        cb.disabled = false;
      });
    }

    function collectSelectedOptions() {
      selectedOptions = [];
      document.querySelectorAll('input[name="option"]').forEach(cb => {
        if (cb.checked) {
          const text = cb.parentNode.querySelector(".option-label-text").textContent;
          selectedOptions.push(text.trim());
        }
      });
      formData.selectedFeatures = selectedOptions;
    }

    /*******************************************************
     * PAGE 9 => 10 (Pairwise)
     *******************************************************/
    function goToPairwise() {
      if (selectedCount !== maxCheckboxes) {
        alert(`Please select exactly ${maxCheckboxes} features before proceeding.`);
        return;
      }
      collectSelectedOptions();

      // Generate random pairs
      const randomPairs = generateRandomPairs(selectedOptions);
      displayPairs(randomPairs);

      showPage("page10");
    }

    // Function to generate random pairs
    function generateRandomPairs(options) {
      let pairs = [];
      let temp = [...options];
      while (temp.length >= 2) {
        const idx1 = Math.floor(Math.random() * temp.length);
        const option1 = temp.splice(idx1, 1)[0];
        const idx2 = Math.floor(Math.random() * temp.length);
        const option2 = temp.splice(idx2, 1)[0];
        pairs.push([option1, option2]);
      }
      // If there's an odd option left, pair it with a random existing pair
      if (temp.length === 1) {
        const randomPair = pairs[Math.floor(Math.random() * pairs.length)];
        randomPair.push(temp[0]);
      }
      return pairs;
    }

    /*******************************************************
     * PAIRWISE (PAGE 10)
     *******************************************************/
    let pairs = [];
    let currentPairIndex = 0;

    function displayPairs(randomPairs) {
      pairs = randomPairs || [];
      formData.pairwiseAnswers = new Array(pairs.length);
      currentPairIndex = 0;
      showPair(currentPairIndex);
    }

    function showPair(i) {
      const container = document.getElementById("pairsContainer");
      container.innerHTML = ""; // Clear previous question

      // If we've answered all pairs, show the final message + Submit button
      if (i >= pairs.length) {
        container.innerHTML = `
          <h5 style="text-align: center;">
            We appreciate you taking the time to share your valuable insights.
            Your feedback will help us improve and shape the future of the automotive industry.
            Stay tuned for updates and insights based on your contributions!
            Have a great day!
          </h5>
        `;
        document.getElementById("submitBtn").style.display = "inline-block";
        return;
      }

      const pair = pairs[i];
      const div = document.createElement("div");
      div.className = "question-container";
      div.innerHTML = `
        <p>Of your 5 selected features, choose the more important one in each pair below:</p>
        <label>
          <input type="radio" name="pair${i}" value="${encodeURIComponent(pair[0])}"
            onchange="recordAnswer(${i}, '${escapeQuotes(pair[0])}')">
          ${pair[0]}
        </label>
        <label>
          <input type="radio" name="pair${i}" value="${encodeURIComponent(pair[1])}"
            onchange="recordAnswer(${i}, '${escapeQuotes(pair[1])}')">
          ${pair[1]}
        </label>
      `;
      container.appendChild(div);
    }

    function escapeQuotes(str) {
      return str.replace(/'/g, "\\'");
    }

    function recordAnswer(index, answer) {
      formData.pairwiseAnswers[index] = decodeURIComponent(answer);
      currentPairIndex++;
      showPair(currentPairIndex);
    }

    /*******************************************************
     * FINAL SUBMISSION
     *******************************************************/
    function handleSubmit() {
      // Check features
      if (formData.selectedFeatures.length !== maxCheckboxes) {
        alert(`Please select exactly ${maxCheckboxes} features.`);
        return;
      }

      // Check pairwise completeness
      if (formData.pairwiseAnswers.includes(undefined)) {
        alert("Please answer all pairwise comparisons.");
        return;
      }

      // Add a timestamp (optional, since Apps Script also adds one)
      formData.timestamp = new Date().toISOString();

      // Define the Web App URL
      const webAppURL = 'https://script.google.com/macros/s/AKfycbxPhCxVaw5ov-hd6ASV-9EPFGixySkSQHA9_HyTBUKZHkDHydLuaSu-CD5IBI107atqwQ/exec'; // <-- Replace with your Web App URL

      // Prepare URL-encoded form data
      const urlEncodedData = new URLSearchParams();
      urlEncodedData.append('data', JSON.stringify(formData));

      // Send data to the Google Apps Script Web App
      fetch(webAppURL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: urlEncodedData.toString()
      })
        .then(response => response.json())
        .then(data => {
          if (data.result === 'success') {
            alert("Form submitted successfully!");
            location.reload();
          } else {
            throw new Error(data.error);
          }
        })
        .catch((error) => {
          console.error('Error!', error.message);
          alert("There was an error submitting the form. Please try again.");
        });
    }

    /*******************************************************
     * INITIALIZATION
     *******************************************************/
    $(document).ready(function () {
      $('#citySelect').select2({
        placeholder: "Select your city",
        allowClear: true
      });
      $('#carSelect').select2({
        placeholder: "Select Car",
        allowClear: true
      });

      // Attach event listeners for radio buttons (optional if using buttons)
      // You can uncomment these if you prefer automatic navigation on selection
      /*
      document.querySelectorAll('input[name="age"]').forEach(input => {
        input.addEventListener('change', nextFromAge);
      });
      document.querySelectorAll('input[name="gender"]').forEach(input => {
        input.addEventListener('change', nextFromGender);
      });
      document.querySelectorAll('input[name="buyingThisYear"]').forEach(input => {
        input.addEventListener('change', checkBuyingThisYear);
      });
      document.querySelectorAll('input[name="owner"]').forEach(input => {
        input.addEventListener('change', nextFromOwner);
      });
      document.querySelectorAll('input[name="budget"]').forEach(input => {
        input.addEventListener('change', nextFromBudget);
      });
      document.querySelectorAll('input[name="fuel"]').forEach(input => {
        input.addEventListener('change', goToFeatures);
      });
      */
    });
  </script>
</body>

</html>
